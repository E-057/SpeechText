<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>音声認識</title>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="TemplateData/UnityProgress.js"></script>
    <script src="Build/UnityLoader.js"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body style="background:#000000">
    <div class="line__container">
        <div class="line__title">
            Amadeus
        </div>
        <div class="line__contents scroll" id="chat_space">

        </div>
        <div class="speech-button off" id="speech">
            <img style="width:30px;" src="image/microphone_black.png" />
        </div>

        <div class"interim__contents>
            <div class="interim">
                <div class="interim_results">・・・</div>
            </div>
        </div>
        <div class="unity" id="unity_space"></div>
    </div>

</body>
</html>

<script>
    SpeechRecognition = webkitSpeechRecognition || SpeechRecognition;
    const recognition = new SpeechRecognition();

    var isActive = false;

    //常に音声認識をON
    recognition.continuous = true;

    //途中結果の受取をON
    recognition.interimResults = true;
    
    $(function () {
        
        var gameInstance = UnityLoader.instantiate("unity_space", "Build/AmadeusApi.json", { onProgress: UnityProgress });

        $("#speech").on("click", function () {
            if ($(this).hasClass("off")) {
                return;
            }

            if (!isActive) {
                recognition.start();
            } else {
                recognition.stop();
            }
        })

        function startSettings() {
            $("#speech").css({ 'background-color': '#dd3030' });
            $(".interim_results").text("・・・");
        }

        function defaultSettings() {
            $("#speech").css({ 'background-color': '#666666' });
            $(".interim_results").text("・・・");
        }

        recognition.onstart = (event) => {
            isActive = true;
            startSettings();
            console.log("onstart");
        }

        recognition.onresult = (event) => {
            $("#speech").css({ 'background-color': '#ff0505' });

            if (event.results[event.results.length - 1].isFinal) {
                gameInstance.SendMessage("Amadeus", "Amadeus", event.results[event.results.length - 1][0].transcript);

                startSettings();

                return;
            }

            $(".interim_results").text(event.results[event.results.length - 1][0].transcript);
        }

        recognition.onerror = (event) => {
            isActive = false;
            defaultSettings();
            console.log("onerror");
        }

        recognition.onend = (event) => {
            isActive = false;
            console.log("onend");
            defaultSettings();
        }

        /*
        function addAmadeusText(text) {
            $(".line__contents").append("<div class= 'line__left' ><div class='name'>Amadeus</div><div class='text'>" + text + "</div></div >");
        }

        function addUserText(text) {

            var date = getDate();

            $(".line__contents").append("<div class= 'line__right' ><div class='text'>" + text + "</div><span class='date'>" + date + "</span></div >");
        }
        */

    });

</script>